# Notify support site when a release is published
# Triggers firmware sync workflow on the support site

name: Notify Support Site of Release

on:
  release:
    types: [published]

jobs:
  notify-support-site:
    name: Trigger Support Site Sync
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract version and release info
        id: release
        run: |
          # Remove 'v' prefix if present
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Format date as YYYY-MM-DD
          RELEASE_DATE=$(echo "${{ github.event.release.published_at }}" | cut -d'T' -f1)
          echo "date=$RELEASE_DATE" >> $GITHUB_OUTPUT

      - name: Trigger support site firmware sync
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.SUPPORT_SITE_PAT }}
          repository: soliddifference/support.soliddifference.com
          event-type: firmware-release
          client-payload: >-
            {
              "version": "${{ steps.release.outputs.version }}",
              "release_notes": "${{ github.event.release.name }}",
              "release_date": "${{ steps.release.outputs.date }}",
              "firmware_type": "esphome"
            }

      - name: Log trigger details
        run: |
          echo "Triggered support site sync for ESPHome firmware"
          echo "Version: ${{ steps.release.outputs.version }}"
          echo "Date: ${{ steps.release.outputs.date }}"
          echo "Notes: ${{ github.event.release.name }}"
